<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dovie PWA ëª¨ë°”ì¼ í…ŒìŠ¤íŠ¸</title>
    <link rel="manifest" href="/manifest.json">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 400px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin: 10px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        button {
            width: 100%;
            padding: 12px;
            background: #7c3aed;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            margin: 8px 0;
            cursor: pointer;
        }
        button:hover {
            background: #6d28d9;
        }
        .status {
            padding: 8px;
            border-radius: 4px;
            margin: 8px 0;
            font-size: 14px;
        }
        .success { background: #d1fae5; color: #065f46; }
        .error { background: #fee2e2; color: #991b1b; }
        .info { background: #dbeafe; color: #1e40af; }
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin: 4px 0;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <h1>ğŸ”” Dovie PWA í…ŒìŠ¤íŠ¸</h1>
    
    <div class="test-card">
        <h3>0. localStorage ë””ë²„ê¹…</h3>
        <button onclick="checkLocalStorage()">localStorage ìƒíƒœ í™•ì¸</button>
        <button onclick="setTestUserId()">í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì ID ì„¤ì •</button>
        <button onclick="clearLocalStorage()">localStorage ì´ˆê¸°í™”</button>
        <div id="storageStatus" class="status info">localStorage ëŒ€ê¸° ì¤‘</div>
    </div>

    <div class="test-card">
        <h3>1. ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸</h3>
        <input type="text" id="username" placeholder="ì‚¬ìš©ìëª…" value="naya2sangyun">
        <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" value="sangyun">
        <button onclick="testLogin()">ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸</button>
        <div id="loginStatus" class="status info">ë¡œê·¸ì¸ ëŒ€ê¸° ì¤‘</div>
    </div>

    <div class="test-card">
        <h3>2. í‘¸ì‹œ ì•Œë¦¼ í…ŒìŠ¤íŠ¸</h3>
        <button onclick="testPushPermission()">ì•Œë¦¼ ê¶Œí•œ ìš”ì²­</button>
        <button onclick="testPushSubscription()">í‘¸ì‹œ êµ¬ë… í…ŒìŠ¤íŠ¸</button>
        <div id="pushStatus" class="status info">í‘¸ì‹œ ì•Œë¦¼ ëŒ€ê¸° ì¤‘</div>
    </div>

    <div class="test-card">
        <h3>3. ë±ƒì§€ í…ŒìŠ¤íŠ¸</h3>
        <button onclick="testBadge()">ì•± ë±ƒì§€ í…ŒìŠ¤íŠ¸</button>
        <button onclick="clearBadge()">ë±ƒì§€ ì§€ìš°ê¸°</button>
        <div id="badgeStatus" class="status info">ë±ƒì§€ ëŒ€ê¸° ì¤‘</div>
    </div>

    <div class="test-card">
        <h3>4. ì•ˆì½ì€ ë©”ì‹œì§€</h3>
        <button onclick="checkUnreadMessages()">ì•ˆì½ì€ ë©”ì‹œì§€ í™•ì¸</button>
        <div id="unreadStatus" class="status info">ì•ˆì½ì€ ë©”ì‹œì§€ ëŒ€ê¸° ì¤‘</div>
    </div>

    <script>
        let currentUser = null;

        function checkLocalStorage() {
            const status = document.getElementById('storageStatus');
            const userId = localStorage.getItem('userId');
            const rememberLogin = localStorage.getItem('rememberLogin');
            const lastLoginTime = localStorage.getItem('lastLoginTime');
            
            status.innerHTML = `
                âœ… localStorage ìƒíƒœ:<br>
                - userId: ${userId || 'null'}<br>
                - rememberLogin: ${rememberLogin || 'null'}<br>
                - lastLoginTime: ${lastLoginTime || 'null'}
            `;
            status.className = 'status success';
        }

        function setTestUserId() {
            localStorage.setItem('userId', '112');
            localStorage.setItem('rememberLogin', 'true');
            localStorage.setItem('lastLoginTime', Date.now().toString());
            
            const status = document.getElementById('storageStatus');
            status.textContent = 'âœ… í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì ID (112) ì„¤ì • ì™„ë£Œ';
            status.className = 'status success';
        }

        function clearLocalStorage() {
            localStorage.removeItem('userId');
            localStorage.removeItem('rememberLogin');
            localStorage.removeItem('lastLoginTime');
            
            const status = document.getElementById('storageStatus');
            status.textContent = 'âœ… localStorage ì´ˆê¸°í™” ì™„ë£Œ';
            status.className = 'status success';
        }

        async function testLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const status = document.getElementById('loginStatus');
            
            try {
                status.textContent = 'ë¡œê·¸ì¸ ì¤‘...';
                status.className = 'status info';
                
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password }),
                    credentials: 'include'
                });

                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    localStorage.setItem('userId', data.user.id.toString());
                    status.textContent = `âœ… ë¡œê·¸ì¸ ì„±ê³µ: ${data.user.displayName} (ID: ${data.user.id})`;
                    status.className = 'status success';
                } else {
                    const error = await response.json();
                    status.textContent = `âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.message}`;
                    status.className = 'status error';
                }
            } catch (error) {
                status.textContent = `âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`;
                status.className = 'status error';
            }
        }

        async function testPushPermission() {
            const status = document.getElementById('pushStatus');
            
            try {
                if (!('Notification' in window)) {
                    status.textContent = 'âŒ ì´ ë¸Œë¼ìš°ì €ëŠ” ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤';
                    status.className = 'status error';
                    return;
                }

                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    status.textContent = 'âœ… ì•Œë¦¼ ê¶Œí•œ í—ˆìš©ë¨';
                    status.className = 'status success';
                } else {
                    status.textContent = 'âŒ ì•Œë¦¼ ê¶Œí•œ ê±°ë¶€ë¨';
                    status.className = 'status error';
                }
            } catch (error) {
                status.textContent = `âŒ ê¶Œí•œ ìš”ì²­ ì‹¤íŒ¨: ${error.message}`;
                status.className = 'status error';
            }
        }

        async function testPushSubscription() {
            const status = document.getElementById('pushStatus');
            
            if (!currentUser) {
                status.textContent = 'âŒ ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”';
                status.className = 'status error';
                return;
            }

            try {
                if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
                    status.textContent = 'âŒ í‘¸ì‹œ ì•Œë¦¼ì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤';
                    status.className = 'status error';
                    return;
                }

                status.textContent = 'í‘¸ì‹œ êµ¬ë… ì„¤ì • ì¤‘...';
                status.className = 'status info';

                // Get VAPID key
                const vapidResponse = await fetch('/api/vapid-public-key');
                const { publicKey } = await vapidResponse.json();

                // Register service worker
                const registration = await navigator.serviceWorker.register('/sw-ios16-enhanced.js');
                await navigator.serviceWorker.ready;

                // Subscribe to push
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(publicKey)
                });

                // Send subscription to server
                const response = await fetch('/api/push-subscription', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': currentUser.id.toString()
                    },
                    body: JSON.stringify({
                        endpoint: subscription.endpoint,
                        keys: {
                            p256dh: arrayBufferToBase64(subscription.getKey('p256dh')),
                            auth: arrayBufferToBase64(subscription.getKey('auth'))
                        }
                    })
                });

                if (response.ok) {
                    status.textContent = 'âœ… í‘¸ì‹œ êµ¬ë… ì™„ë£Œ!';
                    status.className = 'status success';
                } else {
                    const error = await response.json();
                    status.textContent = `âŒ êµ¬ë… ì‹¤íŒ¨: ${error.message}`;
                    status.className = 'status error';
                }
            } catch (error) {
                status.textContent = `âŒ í‘¸ì‹œ êµ¬ë… ì˜¤ë¥˜: ${error.message}`;
                status.className = 'status error';
            }
        }

        async function testBadge() {
            const status = document.getElementById('badgeStatus');
            
            try {
                if ('setAppBadge' in navigator) {
                    await navigator.setAppBadge(5);
                    status.textContent = 'âœ… ì•± ë±ƒì§€ ì„¤ì •ë¨ (5)';
                    status.className = 'status success';
                } else {
                    status.textContent = 'âŒ ì´ ë¸Œë¼ìš°ì €ëŠ” ì•± ë±ƒì§€ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤';
                    status.className = 'status error';
                }
            } catch (error) {
                status.textContent = `âŒ ë±ƒì§€ ì„¤ì • ì‹¤íŒ¨: ${error.message}`;
                status.className = 'status error';
            }
        }

        async function clearBadge() {
            const status = document.getElementById('badgeStatus');
            
            try {
                if ('clearAppBadge' in navigator) {
                    await navigator.clearAppBadge();
                    status.textContent = 'âœ… ì•± ë±ƒì§€ ì œê±°ë¨';
                    status.className = 'status success';
                } else {
                    status.textContent = 'âŒ ì´ ë¸Œë¼ìš°ì €ëŠ” ì•± ë±ƒì§€ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤';
                    status.className = 'status error';
                }
            } catch (error) {
                status.textContent = `âŒ ë±ƒì§€ ì œê±° ì‹¤íŒ¨: ${error.message}`;
                status.className = 'status error';
            }
        }

        async function checkUnreadMessages() {
            const status = document.getElementById('unreadStatus');
            
            if (!currentUser) {
                status.textContent = 'âŒ ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”';
                status.className = 'status error';
                return;
            }

            try {
                const response = await fetch('/api/unread-counts', {
                    headers: {
                        'X-User-ID': currentUser.id.toString()
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const totalUnread = data.unreadCounts.reduce((sum, item) => sum + item.unreadCount, 0);
                    status.textContent = `âœ… ì´ ì•ˆì½ì€ ë©”ì‹œì§€: ${totalUnread}ê°œ`;
                    status.className = 'status success';
                    
                    // Update badge with unread count
                    if ('setAppBadge' in navigator && totalUnread > 0) {
                        await navigator.setAppBadge(totalUnread);
                    }
                } else {
                    status.textContent = 'âŒ ì•ˆì½ì€ ë©”ì‹œì§€ ì¡°íšŒ ì‹¤íŒ¨';
                    status.className = 'status error';
                }
            } catch (error) {
                status.textContent = `âŒ ì¡°íšŒ ì˜¤ë¥˜: ${error.message}`;
                status.className = 'status error';
            }
        }

        // Helper functions
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/-/g, '+')
                .replace(/_/g, '/');

            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);

            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }
    </script>
</body>
</html>